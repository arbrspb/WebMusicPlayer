<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Librosa: Технические настройки</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
    <!-- Красивая кнопка "Назад к настройкам" -->
    <div class="mb-3">
        <a href="/settings" class="btn btn-outline-secondary">
            &larr; Назад к настройкам
        </a>
    </div>
    <h3>Настройки аудиоанализа (librosa)</h3>
    <form id="librosa-form">
        <div class="row">
            <div class="col-md-3">
                <label>sample_rate
                    <input class="form-control" name="sample_rate" type="number" value="{{ settings.sample_rate }}">
                </label>
            </div>
            <div class="col-md-3">
                <label>duration
                    <input class="form-control" name="duration" type="number" value="{{ settings.duration }}">
                </label>
            </div>
            <div class="col-md-3">
                <label>n_mfcc
                    <input class="form-control" name="n_mfcc" type="number" value="{{ settings.n_mfcc }}">
                </label>
            </div>
            <div class="col-md-3">
                <label>n_estimators (деревьев)
                    <input class="form-control" name="n_estimators" type="number" min="10" max="1000" value="{{ settings.n_estimators or 100 }}">
                </label>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-3">
                <label>hop_length
                    <input class="form-control" name="hop_length" type="number" value="{{ settings.hop_length }}">
                </label>
            </div>
            <div class="col-md-3">
                <label>n_fft
                    <input class="form-control" name="n_fft" type="number" value="{{ settings.n_fft }}">
                </label>
            </div>
            <div class="col-md-3">
                <label>win_length
                    <input class="form-control" name="win_length" type="number" value="{{ settings.win_length }}">
                </label>
            </div>
            <div class="col-md-3">
                <label>window
                    <select class="form-select" name="window">
                        <option value="hann" {% if settings.window=='hann' %}selected{% endif %}>hann</option>
                        <option value="hamming" {% if settings.window=='hamming' %}selected{% endif %}>hamming</option>
                        <option value="blackman" {% if settings.window=='blackman' %}selected{% endif %}>blackman</option>
                    </select>
                </label>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-4">
                <label>Порог (genre_threshold)
                    <input class="form-control" name="genre_threshold" type="number" step="0.01" value="{{ settings.genre_threshold }}">
                </label>
            </div>
            <div class="col-md-4 d-flex align-items-center">
                <label class="me-3 mb-0">
                    <input type="checkbox" name="use_id3" {% if settings.use_id3 %}checked{% endif %}> Использовать ID3
                </label>
                <label class="mb-0">
                    <input type="checkbox" name="use_folder" {% if settings.use_folder %}checked{% endif %}> Жанр по папке
                </label>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-2">
                <label><input type="checkbox" name="features.mfcc" {% if settings.features.mfcc %}checked{% endif %}> MFCC</label>
            </div>
            <div class="col-md-2">
                <label><input type="checkbox" name="features.chroma" {% if settings.features.chroma %}checked{% endif %}> Chroma</label>
            </div>
            <div class="col-md-3">
                <label><input type="checkbox" name="features.spectral_contrast" {% if settings.features.spectral_contrast %}checked{% endif %}> Spectral Contrast</label>
            </div>
            <div class="col-md-2">
                <label><input type="checkbox" name="features.zcr" {% if settings.features.zcr %}checked{% endif %}> Zero Crossing Rate</label>
            </div>
            <div class="col-md-3">
                <label><input type="checkbox" name="features.tonnetz" {% if settings.features.tonnetz %}checked{% endif %}> Tonnetz</label>
            </div>
        </div>
    <hr><div class="mb-3">
    <label>
        <input type="checkbox" name="use_rekordbox" id="use_rekordbox" {% if settings.use_rekordbox %}checked{% endif %}>
        Использовать данные из Reckordbox для обучения
    </label>
    <div id="rekordbox-section" style="display: {% if settings.use_rekordbox %}block{% else %}none{% endif %}; margin-top:10px;">
        <div>
            <label><input type="radio" name="rekordbox_source" id="rekordbox-xml-radio" value="xml" checked> XML</label>
            <label class="ms-3"><input type="radio" name="rekordbox_source" id="rekordbox-json-radio" value="json"> JSON</label>
        </div>
        <div id="rekordbox-xml-section" style="margin-top:10px;">
            <div id="rekordbox-status-block"></div>
            <input type="file" id="rekordbox-xml" accept=".xml" class="form-control mt-2 mb-2">
            <button class="btn btn-primary" id="upload-rekordbox-btn" type="button">Загрузить XML</button>
            <button class="btn btn-secondary" id="parse-rekordbox-btn" type="button">Парсить XML</button>
            <div id="rekordbox-progress" class="mt-2"></div>
        </div>
        <div id="rekordbox-json-section" style="display:none; margin-top:10px;">
            <div id="rekordbox-json-status-block"></div>
            <input type="file" id="rekordbox-json" accept=".json" class="form-control mt-2 mb-2">
            <button class="btn btn-primary" id="upload-rekordbox-json-btn" type="button">Загрузить JSON</button>
            <button class="btn btn-secondary" id="parse-rekordbox-json-btn" type="button">Парсить JSON</button>
            <div id="rekordbox-json-progress" class="mt-2"></div>
        </div>
    </div>
</div>
        <button type="submit" class="btn btn-success mt-3">Сохранить</button>
    </form>
    <div id="save-status" class="mt-2"></div>
    <p class="mt-3">
        <a href="/librosa-test" class="btn btn-outline-primary">Тестировать определение жанра &rarr;</a>
    </p>
    <hr>
    <h5>Инструкция по настройке аудиоанализа</h5>
    <ul>
        <li>Здесь вы настраиваете параметры извлечения признаков для аудиоанализа (MFCC и др.).</li>
        <li>При изменении параметров рекомендуется <b>переобучить модель</b> (через настройки или модальное окно).</li>
        <li>После переобучения <b>просканируйте библиотеку заново</b> для корректных результатов.</li>
        <li>Для проверки текущих настроек используйте <a href="/librosa-test">страницу теста</a>.</li>
    </ul>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/js/librosa_settings.js"></script>
</body>
</html>